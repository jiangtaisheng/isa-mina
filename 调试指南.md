# 登录功能调试指南

## 已添加的调试日志

### 1. 登录页面 (src/pages/login/index.tsx)

日志包含：
- ✅ 输入变化追踪（用户名和密码长度）
- ✅ 表单验证状态
- ✅ 登录提交流程
- ✅ 登录结果反馈

### 2. 认证状态管理 (src/store/auth.ts)

日志包含：
- ✅ 登录凭据（密码长度，不显示明文）
- ✅ API 调用状态
- ✅ 响应数据
- ✅ 错误详情（包括 stack trace）

### 3. 认证服务 (src/services/auth.ts)

日志包含：
- ✅ API 地址
- ✅ 请求数据（密码脱敏）
- ✅ 响应状态码和头
- ✅ 完整响应数据
- ✅ Token 和 SID 存储验证

## 如何查看日志

### 微信开发者工具

1. **打开调试器**
   - 在微信开发者工具中，点击顶部菜单 "调试器"
   - 或使用快捷键 `F12`

2. **查看 Console 面板**
   - 点击 "Console" 标签
   - 所有日志会显示在这里

3. **筛选日志**
   - 在 Console 顶部可以输入关键词筛选
   - 建议搜索：`登录`、`API`、`Token`、`❌`（错误）、`✅`（成功）

## 日志解读

### 正常登录成功的日志流程

```
=== 登录页面提交开始 ===
表单数据: { username: "test", passwordLength: 8 }
✅ 表单验证通过
=== Store: 登录开始 ===
登录凭据: { username: "test", passwordLength: 8 }
正在调用 authService.login...
=== Auth Service: 登录 API 调用开始 ===
API 地址: https://api.jiangtaisheng.top/api/login
请求数据: { username: "test", passwordLength: 8 }
发起 Taro.request...
Taro.request 响应:
- statusCode: 200
- data: { code: 0, data: {...}, message: "Login successful" }
✅ 登录成功，保存 token 和 sid
Token: tk_xxx...
SID: sid_xxx...
=== 保存 Token 和 SID ===
✅ Token 已保存
✅ SID 已保存
验证存储 - Token 已保存: true
验证存储 - SID 已保存: true
=== Auth Service: 登录 API 调用结束 ===
authService.login 响应: { code: 0, ... }
✅ Store: 登录成功
登录结果: true
✅ 登录成功，准备跳转
```

### 常见错误日志

#### 错误 1: 网络请求失败

```
=== Auth Service: 登录 API 调用开始 ===
发起 Taro.request...
❌ Auth Service: 登录 API 异常 ===
错误对象: { errMsg: "request:fail ..." }
错误属性: {
  errMsg: "request:fail url not in domain list"
}
```

**解决方案**：
- 在微信公众平台配置服务器域名
- 添加 `https://api.jiangtaisheng.top` 到 request 合法域名

#### 错误 2: 凭据错误

```
Taro.request 响应:
- statusCode: 200
- data: { code: 401, message: "用户名或密码错误" }
❌ 登录失败 - 服务器返回错误
错误码: 401
错误消息: 用户名或密码错误
```

**解决方案**：
- 检查用户名和密码是否正确
- 确认后端 API 是否正常运行

#### 错误 3: 响应格式错误

```
Taro.request 响应:
- data: { error: "Invalid request" }
解析后的 AuthResponse: { error: "Invalid request" }
❌ 登录失败 - 服务器返回错误
错误码: undefined
```

**解决方案**：
- 检查后端 API 返回格式是否符合预期
- 确认 API 接口路径正确

## 手动测试 API

使用 curl 测试后端 API 是否正常：

```bash
# 测试登录接口
curl -X POST https://api.jiangtaisheng.top/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "your_username",
    "password": "your_password"
  }' \
  -v
```

预期响应：
```json
{
  "code": 0,
  "data": {
    "token": "tk_xxx...",
    "sid": "sid_xxx...",
    "expires_at": "2026-01-18T09:12:43.599824"
  },
  "message": "Login successful"
}
```

## 调试检查清单

- [ ] 检查网络请求是否发出（查看 Network 面板）
- [ ] 检查请求 URL 是否正确
- [ ] 检查请求方法是否为 POST
- [ ] 检查请求头 Content-Type 是否为 application/json
- [ ] 检查请求体格式是否正确
- [ ] 检查响应状态码（200, 401, 500 等）
- [ ] 检查响应数据结构
- [ ] 检查域名白名单配置
- [ ] 检查 SSL 证书是否有效（HTTPS）

## 额外调试技巧

### 1. 查看 Network 面板

在微信开发者工具中：
1. 打开 "Network" 标签
2. 进行登录操作
3. 找到 `/api/login` 请求
4. 查看：
   - Request URL
   - Request Method
   - Request Headers
   - Request Payload
   - Response Status
   - Response Data

### 2. 使用 Taro.getStorageSync 查看存储

在 Console 中执行：

```javascript
// 查看存储的 token
Taro.getStorageSync('auth_token')

// 查看存储的 sid
Taro.getStorageSync('auth_sid')

// 查看过期时间
Taro.getStorageSync('auth_expires')
```

### 3. 测试网络请求

在 Console 中执行：

```javascript
// 测试网络请求
Taro.request({
  url: 'https://api.jiangtaisheng.top/api/login',
  method: 'POST',
  header: {
    'Content-Type': 'application/json'
  },
  data: {
    username: 'test',
    password: 'test123'
  }
}).then(res => {
  console.log('测试请求响应:', res);
}).catch(err => {
  console.error('测试请求错误:', err);
});
```

### 4. 清除存储重试

如果怀疑存储有问题：

```javascript
// 清除所有认证信息
Taro.removeStorageSync('auth_token');
Taro.removeStorageSync('auth_sid');
Taro.removeStorageSync('auth_expires');
console.log('已清除所有认证信息');

// 然后重新登录
```

## 常见问题排查

### 问题 1: "request:fail url not in domain list"

**原因**：域名未在微信公众平台配置

**解决**：
1. 登录微信公众平台
2. 开发 → 开发管理 → 开发设置 → 服务器域名
3. 添加 `https://api.jiangtaisheng.top`

### 问题 2: "request:fail timeout"

**原因**：网络超时或服务器无响应

**解决**：
1. 检查网络连接
2. 检查服务器是否正常运行
3. 尝试增加超时时间

### 问题 3: "request:fail"

**原因**：各种网络错误

**解决**：
1. 查看完整的 errMsg
2. 检查 SSL 证书
3. 确认服务器端口开放

### 问题 4: 登录成功但页面未跳转

**原因**：可能 switchTab 页面路径错误

**解决**：
1. 检查 `/pages/tools/index` 是否存在于 app.config.ts
2. 检查该页面是否配置在 tabBar 中
3. 查看是否有 JS 错误

## 下一步

1. 打开微信开发者工具
2. 编译并预览项目
3. 尝试登录
4. 查看控制台日志
5. 根据日志定位问题
6. 使用本指南的解决方案修复

如果问题依然存在，请将完整的日志输出发送给我们进行进一步分析。
