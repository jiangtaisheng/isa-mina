# 小程序部署指南

## 前端部署（微信小程序）

### 步骤 1: 使用微信开发者工具

1. 打开微信开发者工具
2. 导入项目，选择 `dist` 目录
3. 填写小程序 AppID
4. 点击"上传"按钮
5. 填写版本号和项目备注
6. 提交审核

### 步骤 2: 配置服务器域名

在微信公众平台配置以下服务器域名：
- request合法域名：`https://api.jiangtaisheng.top`

访问路径：微信公众平台 -> 开发 -> 开发管理 -> 开发设置 -> 服务器域名

## 后端部署（阿里云 ECS）

### 前提条件
- 已有阿里云 ECS 服务器
- 已备案域名 `api.jiangtaisheng.top`
- 已配置 SSL 证书（HTTPS）

### 部署步骤

#### 1. 连接到服务器
```bash
ssh root@your-server-ip
```

#### 2. 安装 Node.js
```bash
# 使用 NVM 安装 Node.js
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18
```

#### 3. 安装 PM2（进程管理器）
```bash
npm install -g pm2
```

#### 4. 创建项目目录
```bash
mkdir -p /var/www/api
cd /var/www/api
```

#### 5. 上传后端代码
```bash
# 在本地打包后端代码
# 使用 scp 或 git 上传到服务器

# 方式1: 使用 scp
scp -r your-backend-code/* root@your-server-ip:/var/www/api/

# 方式2: 使用 git
git clone your-repo-url /var/www/api
```

#### 6. 安装依赖
```bash
cd /var/www/api
npm install --production
```

#### 7. 配置环境变量
```bash
# 创建 .env 文件
cat > .env << EOF
PORT=5000
NODE_ENV=production
EOF
```

#### 8. 启动服务
```bash
# 使用 PM2 启动
pm2 start npm --name "api-server" -- start

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
```

#### 9. 配置 Nginx 反向代理
```bash
# 安装 Nginx
yum install -y nginx  # CentOS
# 或
apt-get install -y nginx  # Ubuntu

# 创建配置文件
cat > /etc/nginx/conf.d/api.conf << EOF
server {
    listen 80;
    server_name api.jiangtaisheng.top;

    # 重定向到 HTTPS
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.jiangtaisheng.top;

    # SSL 证书配置
    ssl_certificate /path/to/ssl/fullchain.pem;
    ssl_certificate_key /path/to/ssl/privkey.pem;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 反向代理到 Node.js 应用
    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;

        # CORS 配置
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization,sid';

        if (\$request_method = 'OPTIONS') {
            return 204;
        }
    }
}
EOF

# 测试配置
nginx -t

# 重启 Nginx
systemctl restart nginx
systemctl enable nginx
```

#### 10. 配置防火墙
```bash
# 开放必要端口
firewall-cmd --permanent --add-service=http
firewall-cmd --permanent --add-service=https
firewall-cmd --reload
```

### 验证部署

#### 检查服务状态
```bash
# 查看 PM2 状态
pm2 status

# 查看日志
pm2 logs api-server

# 查看 Nginx 状态
systemctl status nginx
```

#### 测试 API
```bash
# 测试注册接口
curl -X POST https://api.jiangtaisheng.top/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'

# 测试登录接口
curl -X POST https://api.jiangtaisheng.top/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123"}'
```

## 常见问题

### 1. 端口被占用
```bash
# 查找占用端口的进程
lsof -i :5000
# 或
netstat -tlnp | grep :5000

# 杀死进程
kill -9 PID
```

### 2. PM2 命令
```bash
pm2 list              # 查看所有进程
pm2 logs api-server   # 查看日志
pm2 restart api-server # 重启服务
pm2 stop api-server    # 停止服务
pm2 delete api-server  # 删除服务
pm2 monit             # 监控面板
```

### 3. Nginx 调试
```bash
# 查看 Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 重新加载配置
nginx -s reload
```

## 安全建议

1. **定期更新系统和依赖**
   ```bash
   yum update -y  # CentOS
   # 或
   apt-get update && apt-get upgrade -y  # Ubuntu
   ```

2. **配置防火墙规则**
   ```bash
   # 只允许必要的端口
   firewall-cmd --permanent --add-service=ssh
   firewall-cmd --permanent --add-service=http
   firewall-cmd --permanent --add-service=https
   firewall-cmd --reload
   ```

3. **使用强密码和 SSH 密钥**
   ```bash
   # 生成 SSH 密钥
   ssh-keygen -t rsa -b 4096

   # 禁用密码登录（编辑 /etc/ssh/sshd_config）
   PasswordAuthentication no
   ```

4. **定期备份数据**
   ```bash
   # 创建备份脚本
   # 可以使用 cron 定期执行
   ```

5. **配置 SSL 证书自动续期**
   ```bash
   # 如果使用 Let's Encrypt
   certbot renew --dry-run
   ```

## 监控和日志

### 使用 PM2 监控
```bash
# 安装 PM2 Plus (可选)
pm2 plus

# 查看实时监控
pm2 monit
```

### 日志管理
```bash
# 配置日志轮换
pm2 install pm2-logrotate

# 查看配置
pm2 conf pm2-logrotate
```
